# Безопасность данных

При интеграции DataGrid с другими системами важно помнить о требованиях к защищаемой информации на стороне клиентского сервиса. Например, к чувствительным данным относятся сертификаты, журналы syslog, данные учетных записей пользователей (логины и пароли), хеш-значения паролей, параметры конфигурации программного компонента, ключи шифрования и другие пользовательские данные. Безопасность журналов syslog обеспечивается настройками на уровне операционной системы, безопасность сертификатов обеспечивается средствами SecMan. Полный список защищаемой информации регламентируется управляющей стороной.

Для обеспечения безопасности пользовательских данных клиентов в DataGrid организована защита данных. К функциям безопасности DataGrid относятся: 

-   прозрачное шифрование данных; 
-   архивирование и восстановление данных кластера при его выходе из строя;
-   постоянное хранение данных (на диске и в оперативной памяти);
-   скрытие конфиденциальной информации (кеш-записей, системных свойств, настроек запуска) в журналах;
-   хранение данных о ролях и пользователях для аутентификации и авторизации.

## Прозрачное шифрование данных (TDE) в DataGrid

Прозрачное шифрование данных (TDE) позволяет пользователям шифровать свои данные в хранилище в автоматическом режиме.

При использовании прозрачного шифрования рекомендуется использовать режим persistence. Когда этот режим включен, шифрование будет выполняться по таблицам или кешам. В этом случае зашифровываться будут следующие данные:

-   данные на диске;
-   записи WAL-журнала.

Если будет включено шифрование по кешам или таблицам, DataGrid сгенерирует ключ (ключ шифрования кеша) и будет использовать его для шифрования/дешифрования данных в кеше. Ключ шифрования кеша содержится в системном кеше и доступ пользователей к нему закрыт. Когда ключ шифрования кеша отправляется на другие узлы или сохранятся на диск (при отключении узла), он зашифровывается при помощи мастер-ключа, который задается пользователем в конфигурации.

В конфигурации каждого узла должен быть определен один и тот же мастер-ключ. Одним из способов удостовериться в том, что везде используется один и тот же мастер-ключ, является копирование JKS-файла с одного узла на другие.

:::{admonition} Внимание
:class: danger

Если попытаться включить TDE, используя разные ключи, то узлы с несовпадающим мастер-ключом не смогут присоединиться к кластеру.
:::

DataGrid использует алгоритмы шифрования, поставляемые в JDK:

-   AES/CBC/PKCS5Padding для шифрования записей WAL-журнала;
-   AES/CBC/NoPadding для шифрования страниц данных на диске.

### Ограничения

#### Шифрование

Для шифрования в DataGrid существуют следующие ограничения:

-   невозможно сменить ключ шифрования во время работы;
-   невозможно зашифровывать/расшифровывать существующие кеши/таблицы.

#### Снепшоты и восстановление

С существующими ограничениями можно ознакомиться в документе «Сценарии администратора» в разделе [«Ограничения процедуры создания резервной копии (снепшота)»](../../administration-guide/md/administration-scenarios.md).

### Конфигурация

Для включения шифрования в кластере необходимо определить мастер-ключ в конфигурации каждого серверного узла.

Пример конфигурации:

::::{md-tab-set}
:::{md-tab-item} XML
```xml
<bean class="org.apache.ignite.configuration.IgniteConfiguration">
    <!-- Чтобы включить функцию шифрования, настройте `EncryptionSpi`. -->
    <property name="encryptionSpi">
        <!-- Использование реализации `EncryptionSpi` на основании хранилища ключей (keystore) Java. -->
        <bean class="org.apache.ignite.spi.encryption.keystore.KeystoreEncryptionSpi">
            <!-- Путь к файлу хранилища ключей. -->
            <property name="keyStorePath" value="ignite_keystore.jks"/>
            <!-- Пароль от файла хранилища ключей. -->
            <property name="keyStorePassword" value="your_password"/>
            <!-- Имя ключа в хранилище (keystore), который будет использоваться в качестве мастер-ключа. -->
            <property name="masterKeyName" value="ignite.master.key"/>
            <!-- Размер ключей шифрования кеша в битах. Может составлять 128, 192 или 256 бит. -->
            <property name="keySize" value="256"/>
        </bean>
    </property>
    <property name="cacheConfiguration">
        <bean class="org.apache.ignite.configuration.CacheConfiguration">
            <property name="name" value="encrypted-cache"/>
            <property name="encryptionEnabled" value="true"/>
        </bean>
    </property>

</bean>
```
:::

:::{md-tab-item} Java
```java
IgniteConfiguration cfg = new IgniteConfiguration();

KeystoreEncryptionSpi encSpi = new KeystoreEncryptionSpi();

encSpi.setKeyStorePath("/home/user/ignite-keystore.jks");
encSpi.setKeyStorePassword("secret".toCharArray());

cfg.setEncryptionSpi(encSpi);
```
:::
::::

Для идентификации мастер-ключа используется его имя. При первом запуске кластера будет использоваться имя мастер-ключа, указанное в конфигурации.

Узлы сохраняют мастер-ключ на диск (в локальный `MetaStorage`) при первой активации кластера и при каждой смене мастер-ключа. При перезагрузке узла он будет использовать имя мастер-ключа из локального `MetaStorage`.

После конфигурирования мастер-ключа включите шифрование для кеша следующим образом:

::::{md-tab-set}
:::{md-tab-item} XML
```xml
<property name="cacheConfiguration">
    <bean class="org.apache.ignite.configuration.CacheConfiguration">
        <property name="name" value="encrypted-cache"/>
        <property name="encryptionEnabled" value="true"/>
    </bean>
</property>
```
:::

:::{md-tab-item} Java
```java
CacheConfiguration<Long, String> ccfg = new CacheConfiguration<Long, String>("encrypted-cache");

ccfg.setEncryptionEnabled(true);

ignite.createCache(ccfg);
```
:::

:::{md-tab-item} SQL
```sql
CREATE TABLE encrypted(
ID BIGINT,
NAME VARCHAR(10),
PRIMARY KEY (ID))
WITH "ENCRYPTED=true";
```
:::
::::

#### Пример генерации мастер-ключа

Хранилище ключей с мастер-ключом можно создать следующим образом с использованием `keytool`:

```bash
user:~/tmp:[]$ java -version
java version "1.8.0_161"
Java(TM) SE Runtime Environment (build 1.8.0_161-b12)
Java HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)
user:~/tmp:[]$ keytool -genseckey \
-alias ignite.master.key \
-keystore ./ignite_keystore.jks \
-storetype PKCS12 \
-keyalg aes \
-storepass your_password \
-keysize 256
user:~/tmp:[]$ keytool \
-storepass your_password \
-storetype PKCS12 \
-keystore ./ignite_keystore.jks \
-list
Keystore type: PKCS12
Keystore provider: SunJSSE
Your keystore contains 1 entry
ignite.master.key, 07.11.2018, SecretKeyEntry,
```

#### Ротация мастер-ключа

Ротация мастер-ключа необходима при компрометации мастер-ключа, а также по окончании криптопериода (периода действительности ключа).

Мастер-ключ зашифровывает кеш-ключи. Зашифрованные кеш-ключи хранятся на диске.

Начиная с версии 2.9 в DataGrid предусмотрен процесс смены (ротации) мастер-ключа, позволяющий пользователям задать новый мастер-ключ и перешифровать кеш-ключи.

##### Требования

1. Новый мастер-ключ должен быть виден `EncryptionSpi` для каждого серверного узла. Пример конфигурации мастер-ключа приведен в разделе «Конфигурация» выше.
2. Кластер должен быть активен. Пример активации кластера приведен в документе [«Руководство по установке»](../../installation-guide/md/index.md).

#### Смена мастер-ключа

DataGrid предлагает пользователям три способа смены мастер-ключа с использованием следующих интерфейсов:

-   командная строка;
-   JMX;
-   программный код.

##### Командная строка

В поставку DataGrid входит скрипт `control.sh|bat`, хранящийся в директории `$IGNITE_HOME/bin`. Этот скрипт выступает в роли инструмента управления мастер-ключом из командной строки. Ниже указаны команды, которые используются для работы с `control.sh|bat`:

```bash
 Print the current master key name.
control.sh|bat --encryption get_master_key_name

 Change the master key.
control.sh|bat --encryption change_master_key newMasterKeyName
```

##### JMX

Управлять процессом смены мастер-ключа также можно и через интерфейс `EncryptionMXBean`:

| Метод | Описание |
|---|---|
| `getMasterKeyName()` | Отображает имя текущего мастер-ключа |
| `changeMasterKey(String masterKeyName)` | Запускает процесс смены мастер-ключа |

##### Программный код

Также управление процессом смены мастер-ключа может выполняться программно.

:::{code-block} java
:caption: Java
// Возвращает имя текущего мастер-ключа.
String name = ignite.encryption().getMasterKeyName();

// Запускает процесс смены мастер-ключа.
IgniteFuture<Void> future = ignite.encryption().changeMasterKey("newMasterKeyName");
:::

### Восстановление мастер-ключа на неработающем узле

Если тот или иной узел выходит из обслуживания во время процесса смены мастер-ключа, он не сможет подключиться к кластеру, используя старый мастер-ключ. Узлу необходимо будет перешифровать ключи локальной группы во время восстановления при запуске. Актуальное имя мастер-ключа должно быть установлено системным свойством `IGNITE_MASTER_KEY_NAME_TO_CHANGE_BEFORE_STARTUP` перед запуском узла. Узел сохраняет имя ключа в локальный `MetaStorage`, когда кластер активен.

:::{admonition} Примечание
:class: note

Рекомендуется удалять системное свойство после успешного восстановления, иначе сохранится возможность использования неправильного имени мастер-ключа после перезагрузки узла.
:::

## Архивирование и восстановление

DataGrid обладает широкой функциональностью, обеспечивающей возможность архивирования и восстановления данных кластера при выходе его из строя. Такая функциональность обеспечивается при помощи трех основных инструментов:

-   WAL-журнал.
-   Checkpointing.
-   Persistent Data Store.

### WAL-журнал

WAL-журнал необходим для восстановления записей после сбоя. Данный механизм позволяет исключить потерю данных.

В зависимости от режима работы WAL-журнала DataGrid предоставляет следующие гарантии согласованности данных:

| Режим работы WAL-журнала | Описание | Гарантии |
|---|---|---|
| `BACKGROUND` | При включенной функции `IGNITE_WAL_MMAP` (включена по умолчанию) данный режим работает так же, как `LOG_ONLY`. Если функция `IGNITE_WAL_MMAP` отключена, изменения остаются во внутреннем буфере узла. Частота сохранения буфера на диск определяется с помощью параметра `DataStorageConfiguration.setWalFlushFrequency` | При включенной функции `IGNITE_WAL_MMAP` (включена по умолчанию), данный режим предоставляет такие же гарантии, как и режим `LOG_ONLY`. При отключении данной функции возможна потеря данных |
| `FSYNC` | Изменения гарантированно сохраняются на диск ОС для каждой записи или каждого подтверждения транзакции | Данные не теряются, переживают любые сбои. Это самый надежный, но самый ресурсоемкий режим |
| `LOG_ONLY` | В настоящий момент данный режим используется по умолчанию. Все записи попадают в буферный кеш ОС, сброс записей на диск зависит от настроек ОС | Данные в этом режиме переживают только сбой узла |
| `NONE` | Отключает WAL-журнал. Изменения в данном режиме работы сохраняются только при правильном отключении узла. Для деактивации кластера и отключения узла используйте параметр `Ignite\#active(false)` | Если работа узла DataGrid была завершена неправильно, то увеличивается вероятность отсутствия синхронизации данных или их повреждения. Для перезагрузки узла необходимо очистить директорию сохранения данных |

### Создание контрольных точек (checkpointing)

Данный процесс помогает экономно использовать пространство диска, поддерживая страницы на диске в наиболее актуальном состоянии и давая возможность удаления «старых» сегментов (файлов) WAL-журнала из архива WAL.

Checkpointing позволяет обеспечить восстановление последнего рабочего состояния кластера до его сбоя.

## Persistent Data Store

PDS (постоянное хранилище данных) — это набор функций, специально разработанных для постоянного хранения данных. При включенном PDS DataGrid сохраняет все данные на диске, а некоторое их количество, необходимое для обработки, хранит в оперативной памяти.

Если PDS отключен, то внешнее хранилище данных не используется, и DataGrid работает только как хранилище данных в оперативной памяти.

Отключение PDS грозит потерей данных о пользователях и их неконсистентностью.

Рекомендуется всегда включать Persistent Data Store во избежание возможной потери данных о пользователях при перезапуске кластера.

## Назначение разрешений в плагине безопасности для работы с резервным копированием

Для любой операции с резервным копированием пользователю должно быть предоставлено разрешение `SecurityPermission#ADMIN_SNAPSHOT`.

Разрешение `SecurityPermission#ADMIN_SNAPSHOT` добавляется пользователем с ролью `SECURITY_ADMIN` при помощи графической или консольной утилит администрирования, либо devops job при первоначальной установке прав в JSON-файле.

Данное разрешение выдается пользователю в качестве системного.

:::{admonition} Примечание
:class: note

Текущая реализация плагина безопасности позволяет назначить данное разрешение любой из ролей, однако по умолчанию данное разрешение предоставляется только роли `MAINTENANCE_ADMIN`. Рекомендуется использовать настройку по умолчанию.
:::

С подробным описанием ролевой модели DataGrid, а также применяемыми к каждой роли разрешениями вы можете ознакомиться в разделе [«Ролевая модель в DataGrid»](authorisation.md).

## Скрытие конфиденциальной информации в журналах

В журналах может отражаться содержание кеш-записей, системных свойств, настроек запуска и прочая информация, которая в некоторых случаях может быть конфиденциальной. Отображение такой информации в журналах можно отключить, для этого установите значение системного свойства `IGNITE_TO_STRING_INCLUDE_SENSITIVE = false` с помощью команды:

```bash
./ignite.sh -J-DIGNITE_TO_STRING_INCLUDE_SENSITIVE=false
```

## Хранение данных о ролях и пользователях для аутентификации и авторизации

Для хранения данных о пользователях и ролях плагин использует `distributed metastorage`.

Записи плагина безопасности в `distributed metastorage` бывают двух видов:

-   данные пользователя: логин, хеш пароля, список имен ролей;
-   данные роли: имя роли, набор разрешений DataGrid.

Для аутентификации используются только записи данных пользователя, а для авторизации — записи обоих видов.
