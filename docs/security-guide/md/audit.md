# Аудит

Плагин безопасности дает возможность аудировать события. В поставке DataGrid есть две интеграции для отправки событий аудита во внешние системы: Syslog и UDP Syslog. Подробнее об этих интеграциях написано в подразделе [«Настройка аудита событий DataGrid»](../../administration-guide/md/administration-scenarios.md#настройка-аудита-событий-datagrid) раздела «Сценарии администрирования» документа «Руководство по системному администрированию».

Для аудита используется syslog, который развернут на локальном хосте. В него будут отправляться следующие события, которые относятся к информационной безопасности:

:::{list-table}
:header-rows: 1

+   *   Тип события
    *   Подтипы события
    *   Существенные поля
+   *   Авторизация
    *   - Успех.
        - Неудача
    *   - Авторизуемое разрешение.
        - Имя объекта (например кеша), к которому применяется разрешение (для некоторых разрешений не заполняется).
        - Логин.
        - Идентификатор субъекта аутентификации.
        - Адреса субъекта аутентификации.
        - Идентификатор кластера
+   *   Аутентификация. Субъектами могут быть как узлы DataGrid, так и клиентские подключения
    *   - Успех.
        - Неудача
    *   - Тип субъекта аутентификации (узел или клиентское подключение).
        - Логин.
        - Идентификатор субъекта аутентификации.
        - Адреса субъекта аутентификации.
        - Идентификатор кластера.
        - Сертификаты субъекта аутентификации (cname + fingerprint)
+   *   Выполнение запросов (scan, full-text, SQL, continuous)
    *   - Запрос отправлен на исполнение (только для `SqlFieldsQuery`).
        - Прочитаны данные из кеша.
        - Запрос выполнен
    *   - Логин.
        - Имя кеша.
        - Значение ключа (только для события чтения данных из кеша).
        - Тип запроса.
        - Текст запроса.
        - Идентификатор субъекта аутентификации.
        - Адреса субъекта аутентификации
+   *   Изменение топологии кластера
    *   - Узел вошел в топологию.
        - Узел вышел из топологии.
        - Узел вышел из топологии нештатно.
        - Узел определил, что он работает в недопустимом сегменте сети.
        - Клиентский узел потерял соединение.
        - Клиентский узел восстановил соединение
    *   - Логин (узла, к которому относится событие).
        - Версия топологии.
        - Идентификатор субъекта аутентификации (узла).
        - Адреса субъекта аутентификации (узла)
+   *   Обращение по протоколу Binary REST
    *   - Успешное завершение выполнения REST-запроса.
        - Выполнение REST-запроса завершилось ошибкой.
        - Не удалось аутентифицировать инициатора REST-запроса.
        - REST-запрос не был авторизован.
        - Выполнение REST-запроса завершилось ошибкой.
        - Выполнение REST-запроса завершилось с неизвестным статусом
    *   - Логин.
        - Идентификатор субъекта аутентификации.
        - Адреса субъекта аутентификации.
        - Название команды.
        - Описание команды.
        - Статус выполнения команды (успех или неудача, с сообщением об ошибке)
+   *   Попытка использования истекшего сертификата при подключении к узлу кластера
    *   —
    *   Информация о сертификате (common name, fingerprint, ...)
+   *   Создание/удаление кеша
    *   - Кеш создан.
        - Кеш удален
    *   - Логин.
        - Идентификатор субъекта аутентификации.
        - Адреса субъекта аутентификации.
        - Имя кеша
+   *   Узел, пытавшийся войти в кластер, не прошел валидацию
    *   —
    *   - Логин (узла, к которому относится событие).
        - Идентификатор субъекта аутентификации (узла).
        - Адреса субъекта аутентификации (узла)
:::

## Список генерируемых событий, которые отправляются в syslog

| Событие | Расшифровка |
|---|---|
| `AUTHORIZATION_SUCCEEDED` | Авторизация завершилась успешно |
| `AUTHORIZATION_FAILED` | Авторизация завершилась неуспешно |
| `AUTHENTICATION_SUCCEEDED` | Аутентификация завершилась успешно |
| `AUTHENTICATION_FAILED` | Аутентификация завершилась неуспешно |
| `USER_CREATED` | Создание учетной записи пользователя |
| `USER_REMOVED` | Удаление учетной записи пользователя |
| `USER_UPDATED` | Изменение учетной записи пользователя |
| `ROLE_CREATED` | Создание роли |
| `ROLE_REMOVED` | Удаление роли |
| `ROLE_UPDATED` | Изменение роли |
| `USER_PASSWORD_UPDATED` | Изменение пароля пользователя |
| `SECURITY_MANAGEMENT_FAILED` | Ошибка операции, связанной с управлением данными безопасности |
| `ROLE_GET` | Получение информации о роли |
| `USER_GET` | Получение информации о пользователе |
| `CERTIFICATE_EXPIRED` | Истек срок действия сертификата |
| `CERTIFICATE_EXPIRING` | Истекает срок действия сертификата |
| `NODE_JOINED` | Узел вошел в топологию |
| `NODE_JOIN_FAILED` | Узел не смог войти в топологию |
| `NODE_LEFT` | Узел вышел из топологии |
| `NODE_FAILED` | Узел вышел из топологии нештатно |
| `MANAGEMENT_TASK_STARTED` | Запуск управляющей задачи |
| `CACHE_CREATED` | Кеш создан |
| `CACHE_DESTROYED` | Кеш удален |
| `QUERY_EXECUTION` | Запрос исполнен |
| `CLUSTER_SNAPSHOT_STARTED` | Запуск создания резервной копии |
| `CLUSTER_SNAPSHOT_FINISHED` | Успешное создание резервной копии |
| `CLUSTER_SNAPSHOT_FAILED` | Ошибки создания резервной копии |
| `CLUSTER_SNAPSHOT_RESTORE_STARTED` | Запуск восстановления резервной копии |
| `CLUSTER_SNAPSHOT_RESTORE_FINISHED` | Успешное восстановление резервной копии |
| `CLUSTER_SNAPSHOT_RESTORE_FAILED` | Ошибка восстановления резервной копии |
| `CLUSTER_STATE_CHANGE_STARTED` | Изменение состояния кластера |
| `SECMAN_UNWRAP_TOKEN` | Unwrap SecMan-токена |
| `SECMAN_UNWRAP_TOKEN_FAILED` | Ошибка unwrap SecMan-токена |
| `SECMAN_WRAP_TOKEN` | Wrap SecMan-токена |
| `SECMAN_WRAP_TOKEN_FAILED` | Ошибка wrap SecMan-токена |
| `SECMAN_READ` | Чтение секретов SecMan |
| `SECMAN_READ_FAILED` | Ошибка чтения секретов SecMan |
| `SECMAN_FETCH` | Чтение сертификата SecMan |
| `SECMAN_FETCH_FAILED` | Ошибка чтения сертификата SecMan |

## Параметры событий

| Операция | Поле | Описание поля | Наличие на КУ | Наличие на СУ |
|---|---|---|---|---|
| Аутентификация | Идентификатор события | Идентификатор события | | |
| | Время | Дата и время по Гринвичу | | |
| | Идентификатор узла | Идентификатор узла, на котором производится запись события | Всегда ID узла | Всегда ID узла |
| | Адрес узла | IP-адрес узла, на котором производится запись события | Всегда ID узла | Всегда ID узла |
| | Тип субъекта | Тип субъекта: REMOTE\_NODE — удаленный узел (серверный или клиентский) REMOTE\_CLIENT — удаленный клиент | | |
| | Идентификатор субъекта | Идентификатор субъекта (для объектов) | = localNodeId | ID субъекта аутентификации |
| | Адрес субъекта | IP-адрес субъекта (для объектов) | = localAddresses | Х |
| | Наличие прав на выполнение | Статус наличия прав у УЗ на выполнение операции \[True\|False\] | | |
| | Статус выполнения операции | Статус выполнения операции \[True\|False\] | | |
| | Использование SSL | Статус конфигурирования кластера с использованием SSL \[True\|False\] | | |
| | Идентификатор кластера | Наименование кластера, на котором произошло событие | | |
| | Сертификаты | CN и fingerprint сертификата, используемого при аутентификации | | |
| Операции с кешами (-/+ отсутствует, либо добавляется соответствующее поле, относительно списка полей аутентификации) | \- Наличие прав на выполнение | Статус наличия прав у УЗ на выполнение операции \[True\|False\] | | |
| | \- Тип субъекта | Тип субъекта: REMOTE\_NODE — удаленный узел (серверный или клиентский) REMOTE\_CLIENT — удаленный клиент | | |
| | \+ Название кеша | Имя кеша | | |
| Управляющие операции по протоколу Binary REST (-/+ отсутствует, либо добавляется соответствующее поле, относительно списка полей аутентификации) | \- Наличие прав на выполнение | Статус наличия прав у УЗ на выполнение операции \[True\|False\] | | |
| | \+ Описание операции | Имя операции | | |
| | \+ Контекст операции | Контекст операции (детализация выполнения операции, полный список всех используемых параметров — фиксируется для всех выполняемых операций, кроме: создания новой УЗ и смены пароля УЗ. При этих событиях записывается только соответствующее информационное сообщение с указанием логина учетной записи) | | |
| | \+ Ошибка | Описание ошибки, в случае ее возникновения | | |

## Настройка параметров аудита

### Плагин Audit Syslog

Плагин позволяет аудировать события в кластере с помощью их записи в syslog. Плагин предоставляет два механизма записи в syslog: в [локальный Unix-сокет](#настройка-логирования-в-unix-сокете) и на [удаленный UDP-сервер](#настройка-логирования-на-udp-сервер).

#### Настройка логирования в Unix-сокете

Процесс `Ignite` подключается к локальному Unix-сокету syslog с помощью системных вызовов `openlog()` и `syslog()`. При подключении используется `ident = IgniteSE`. Сообщения отправляются с `Facility LOCAL3` с уровнем логирования `INFO`.

Для настройки задайте конфигурацию аудита с необязательными параметрами:

:::{code-block} xml
:caption: XML
<bean id="securityPluginConfiguration" class="com.sbt.security.ignite.core.SecurityPluginConfiguration">
<property name="auditIntegrationConfiguration" ref="auditCfg"/>
</bean>

<bean id="auditCfg" class="com.sbt.security.ignite.integration.audit.syslog.SyslogIntegrationConfiguration">
<property name="sourceSystemName" value="IgniteSE"/>
<property name="moduleName" value="IgniteSE"/>
<property name="nodeName" value="localhost"/>
</bean>
:::

**Требуемые параметры конфигурации:**

1. `sourceSystem` — название пользовательской автоматизированной системы (по умолчанию `IgniteSE`).
2. `moduleName` — название кластера (по умолчанию `IgniteSE`).
3. `nodeName` — название конкретного узла в кластере (по умолчанию имя хоста на локальном узле).

#### Настройка логирования на UDP-сервер

Для настройки задайте конфигурацию аудита с параметрами:

:::{code-block} xml
:caption: XML
<bean id="securityPluginConfiguration" class="com.sbt.security.ignite.core.SecurityPluginConfiguration">
<property name="auditIntegrationConfiguration" ref="auditCfg"/>
</bean>

<bean id="auditCfg" class="com.sbt.security.ignite.integration.audit.syslog.UdpSyslogIntegrationConfiguration">
<property name="sourceSystemName" value="IgniteSE"/>
<property name="moduleName" value="IgniteSE"/>
<property name="nodeName" value="localhost"/>

<property name="host" value="localhost"/>
<property name="port" value="4555"/>
<property name="facility" value="LOCAL3"/>
<property name="severity" value="INFORMATIONAL"/>
</bean>
:::

**Требуемые параметры конфигурации:**

1. `sourceSystem` — название пользовательской автоматизированной системы (по умолчанию `IgniteSE`).
2. `moduleName` — название кластера (по умолчанию `IgniteSE`).
3. `nodeName` — название конкретного узла в кластере (по умолчанию имя хоста на локальном узле).
4. `host` — имя хоста, на котором запущен UDP-сервер.
5. `port` — номер порта, на котором запущен UDP-сервер.
6. `facility` — параметр syslog (по умолчанию `LOCAL3`).
7. `severity` — параметр syslog (по умолчанию `INFORMATIONAL`).